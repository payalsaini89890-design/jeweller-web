<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wishlist | The Jewellery Atelier</title>

    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/collections.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/gallery.css">
    <link rel="stylesheet" href="css/mobile-menu.css">
    <link rel="stylesheet" href="css/dossier.css">
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.34/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="js/env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/ticker.js" defer></script>
</head>

<body class="luxury-theme">

    <header id="header">
        <a href="index.html" class="logo">THE ATELIER</a>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="heritage.html">The Heritage</a></li>
                <li><a href="collections/gold.html">Gold Collection</a></li>
                <li><a href="collections/platinum.html">Platinum Collection</a></li>
                <li><a href="contact.html">Visit Store</a></li>
                <li><a href="ai.html">AI Concierge</a></li>
                <li><a href="wishlist.html" class="active" title="Wishlist" style="position: relative; font-size: 1.2rem;">♥ <span id="wishlist-count" style="display: none;">0</span></a></li>
            </ul>
        </nav>
    </header>

    <main style="padding-top: 120px;">
        <section class="collection-hero">
            <div class="section-intro">
                <span class="gold-label">Your Favorites</span>
                <h1 style="font-family: var(--serif); font-weight: 400; font-size: 3rem; margin-top: 20px;">My Personal Wishlist</h1>
                <p style="max-width: 600px; margin: 20px auto; color: var(--text-muted); font-weight: 300;">Your curated
                    selection of our finest craftsmanship. Save them for your next visit.</p>
            </div>

            <div class="jewelry-grid" id="wishlist-grid" style="min-height: 400px;">
                <div class="loading-state" style="text-align: center; width: 100%; padding-top: 100px;">
                    <p>Loading your wishlisted items...</p>
                </div>
            </div>
        </section>
    </main>

    <div id="dossier-root"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">THE JEWELLERY ATELIER</div>
            <p>© 2026 The Jewellery Atelier Flagship. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/gallery.js"></script>
    <script src="js/wishlist.js"></script>
    <script src="js/mobile-menu.js"></script>
    <script src="js/dossier.js"></script>
    <script>
        let wishlistedItems = [];
        let currentJewelleryId = null;

        async function loadWishlistItems() {
            const grid = document.getElementById('wishlist-grid');
            const userId = localStorage.getItem('atelier_user_id');

            if (!userId) {
                grid.innerHTML = '<p style="text-align: center; width: 100%;">Your wishlist is empty.</p>';
                return;
            }

            try {
                // Get IDs from wishlist table
                const { data: list, error: listError } = await window.supabaseText
                    .from('wishlists')
                    .select('jewellery_id')
                    .eq('user_identifier', userId);

                if (listError) throw listError;

                if (!list || list.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; width: 100%;">Your wishlist is empty.</p>';
                    return;
                }

                const ids = list.map(item => item.jewellery_id);

                // Fetch full item details
                const { data: items, error: itemError } = await window.supabaseText
                    .from('jewellery')
                    .select('*')
                    .in('id', ids);

                if (itemError) throw itemError;
                wishlistedItems = items || [];
                renderWishlistGrid();

            } catch (err) {
                console.error('Error loading wishlist:', err);
                grid.innerHTML = '<p style="text-align: center; width: 100%;">Failed to load wishlist.</p>';
            }
        }

        function renderWishlistGrid() {
            const grid = document.getElementById('wishlist-grid');
            grid.innerHTML = '';

            if (wishlistedItems.length === 0) {
                grid.innerHTML = '<p style="text-align: center; width: 100%;">Your wishlist is empty.</p>';
                return;
            }

            wishlistedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="image-container" onclick="openProductDetail('${item.id}')">
                        <img src="${item.image_url}" alt="${item.name}">
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-top:15px;">
                        <h3 onclick="openProductDetail('${item.id}')" style="margin:0; cursor:pointer;">${item.name}</h3>
                        <button class="wishlist-btn wishlisted" onclick="event.stopPropagation(); removeFromWishlist('${item.id}')">♥</button>
                    </div>
                    <span class="price-tag">${item.price}</span>
                `;
                grid.appendChild(card);
            });
        }

        let allItems = []; // For Dossier compatibility

        function openProductDetail(id) {
            dossier.open(id, wishlistedItems);
            allItems = wishlistedItems; 
        }

        async function removeFromWishlist(id) {
            await wishlistManager.remove(id);
            wishlistedItems = wishlistedItems.filter(it => it.id !== id);
            renderWishlistGrid();
            if (currentJewelleryId === id) closeProduct();
        }

        function closeProduct() {
            document.getElementById('panel').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function handleEnquiry() {
            const item = wishlistedItems.find(it => it.id === dossier.productId);
            openEnquiryModal(item);
        }

        document.addEventListener('DOMContentLoaded', loadWishlistItems);
        document.getElementById('overlay').onclick = closeProduct;
    </script>
</body>

</html>